<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(init);

      async function init() {
        await loadNumericColumns();
        await loadStringColumns();

        const limitInput = document.getElementById('limit');
        limitInput.addEventListener('input', drawChart);

        drawChart();
      }

      async function loadNumericColumns() {
        const response = await fetch('/api/numeric_columns');
        const columns = await response.json();

        const dropdownX = document.getElementById('columnX');
        const dropdownY = document.getElementById('columnY');

        columns.sort().forEach(column => {
          const optionX = document.createElement('option');
          optionX.value = column;
          optionX.text = column;
          dropdownX.appendChild(optionX);

          const optionY = document.createElement('option');
          optionY.value = column;
          optionY.text = column;
          dropdownY.appendChild(optionY);
        });

        dropdownX.addEventListener('change', drawChart);
        dropdownY.addEventListener('change', drawChart);
      }

      async function loadStringColumns() {
        const response = await fetch('/api/string_columns');
        const columns = await response.json();

        const dropdownFilter = document.getElementById('filter');

        columns.sort().forEach(column => {
          const option = document.createElement('option');
          option.value = column;
          option.text = column;
          dropdownFilter.appendChild(option);
        });

        dropdownFilter.addEventListener('change', loadFilterValues);
      }

      async function loadFilterValues() {
        const dropdownFilter = document.getElementById('filter');
        const dropdownFilterValue = document.getElementById('filterValue');

        const column = dropdownFilter.value;

        if (!column) {
          return;
        }

        dropdownFilterValue.innerHTML = '';

        const response = await fetch(`/api/distinct_values_for_column?column=${column}`);
        const values = await response.json();

        values.sort().forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          dropdownFilterValue.appendChild(option);
        });

        dropdownFilterValue.removeEventListener('change', drawChart);
        dropdownFilterValue.addEventListener('change', drawChart);

        drawChart();
      }

      async function drawChart() {
        const dropdownX = document.getElementById('columnX');
        const dropdownY = document.getElementById('columnY');
        const dropdownFilter = document.getElementById('filter');
        const dropdownFilterValue = document.getElementById('filterValue');
        const limitInput = document.getElementById('limit');

        const axeX = dropdownX.value;
        const axeY = dropdownY.value;
        const filterColumn = dropdownFilter.value;
        const filterValue = dropdownFilterValue.value;
        const limit = limitInput.value;

        if (!axeX || !axeY) {
          return;
        }

        const requestBody = {
          axeX: axeX,
          axeY: axeY,
          filterColumn: filterColumn || null,
          filterValue: filterValue || null,
          limit: limit || null
        };

        console.log('POST /api/numeric_values', requestBody);
        const response = await fetch('/api/numeric_values', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        const values = await response.json();

        const chartData = [[axeX, axeY]];
        values.forEach(row => {
          chartData.push(row);
        });

        var data = google.visualization.arrayToDataTable(chartData);

        var options = {
          title: `${axeX} vs ${axeY}`,
          hAxis: {title: axeX},
          vAxis: {title: axeY},
          legend: 'none'
        };

        var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));

        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div>
      <label for="columnX">Axe X:</label>
      <select id="columnX"></select>

      <label for="columnY">Axe Y:</label>
      <select id="columnY"></select>
    </div>
    <div>
      <label for="filter">Filter:</label>
      <select id="filter"></select>

      <label for="filterValue">Filter Value:</label>
      <select id="filterValue"></select>
    </div>
    <div>
      <label for="limit">Limit:</label>
      <input type="number" id="limit" min="1" placeholder="No limit">
    </div>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
  </body>
</html>